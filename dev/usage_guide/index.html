<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Usage Guide · WeightedSampling.jl</title><meta name="title" content="Usage Guide · WeightedSampling.jl"/><meta property="og:title" content="Usage Guide · WeightedSampling.jl"/><meta property="twitter:title" content="Usage Guide · WeightedSampling.jl"/><meta name="description" content="Documentation for WeightedSampling.jl."/><meta property="og:description" content="Documentation for WeightedSampling.jl."/><meta property="twitter:description" content="Documentation for WeightedSampling.jl."/><meta property="og:url" content="https://MariusFurter.github.io/WeightedSampling.jl/usage_guide/"/><meta property="twitter:url" content="https://MariusFurter.github.io/WeightedSampling.jl/usage_guide/"/><link rel="canonical" href="https://MariusFurter.github.io/WeightedSampling.jl/usage_guide/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">WeightedSampling.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Usage Guide</a><ul class="internal"><li><a class="tocitem" href="#Installation"><span>Installation</span></a></li><li><a class="tocitem" href="#Quick-start"><span>Quick start</span></a></li><li><a class="tocitem" href="#SMCKernel-type"><span>SMCKernel type</span></a></li><li><a class="tocitem" href="#MH-moves"><span>MH moves</span></a></li><li><a class="tocitem" href="#Utility-functions"><span>Utility functions</span></a></li><li><a class="tocitem" href="#Performance-tips"><span>Performance tips</span></a></li><li><a class="tocitem" href="#Saving-particle-history"><span>Saving particle history</span></a></li></ul></li><li><a class="tocitem" href="../api/">API Reference</a></li><li><a class="tocitem" href="../examples/">Examples</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Usage Guide</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Usage Guide</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/MariusFurter/WeightedSampling.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/MariusFurter/WeightedSampling.jl/blob/main/docs/src/usage_guide.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p><code>WeightedSampling.jl</code> provides the <code>@smc</code> macro for concise specification of Sequential Monte Carlo (SMC) sampling schemes. It transforms probabilistic programs into efficient particle filters with automatic resampling and weight management. It excels at dynamic and moderate-dimensional statistical models (&lt; 1k parameters).</p><p><strong>Note:</strong> This package is in early development. Use with caution.</p><h2 id="Installation"><a class="docs-heading-anchor" href="#Installation">Installation</a><a id="Installation-1"></a><a class="docs-heading-anchor-permalink" href="#Installation" title="Permalink"></a></h2><p>The package is not yet registered in the Julia General Registry. Install directly from this repository:</p><pre><code class="language-terminal hljs">add https://github.com/MariusFurter/WeightedSampling.jl</code></pre><h2 id="Quick-start"><a class="docs-heading-anchor" href="#Quick-start">Quick start</a><a id="Quick-start-1"></a><a class="docs-heading-anchor-permalink" href="#Quick-start" title="Permalink"></a></h2><h3 id="Linear-regression"><a class="docs-heading-anchor" href="#Linear-regression">Linear regression</a><a id="Linear-regression-1"></a><a class="docs-heading-anchor-permalink" href="#Linear-regression" title="Permalink"></a></h3><pre><code class="language-julia hljs">using WeightedSampling

@smc function linear_regression(xs, ys)
    α ~ Normal(0, 1) # sample
    β ~ Normal(0, 1)
    for (x, y) in zip(xs, ys)
        y =&gt; Normal(α + β * x, 1.0) # observe
    end
end

xs = 1:10
ys = 1-0 .- 0.5 .* xs .+ 0.5 * randn(length(xs))

particles, evidence = linear_regression(xs, ys, n_particles=1000, ess_perc_min=0.5)
describe_particles(particles)</code></pre><h3 id="Bootstrap-particle-filter"><a class="docs-heading-anchor" href="#Bootstrap-particle-filter">Bootstrap particle filter</a><a id="Bootstrap-particle-filter-1"></a><a class="docs-heading-anchor-permalink" href="#Bootstrap-particle-filter" title="Permalink"></a></h3><pre><code class="language-julia hljs">@smc function ssm(obs)
    I = [1 0; 0 1]     # local variable
    x1 .= [0.0, 0.0]   # assign
    v .= [1.0, 0.0]
    for (i, o) in enumerate(obs)
        x{i + 1} .= x{i} + v             # dynamic variable creation
        dv ~ MvNormal([0, 0], 0.1 * I)   # sample
        v .= v + dv
        o =&gt; MvNormal(x{i + 1}, 0.5 * I) # observe
    end
end</code></pre><p>The <code>@smc</code> macro generates functions that propagate a DataFrame <code>particles</code> of weighted samples through SMC kernels. Particle variables are stored as columns (e.g., <code>particles.x</code>), with log-weights in <code>particles.weights</code>. Resampling occurs when the effective sample size drops below <code>ess_perc_min</code>. The macro generates two SMC functions:</p><pre><code class="language-julia hljs"># In-place (modifies existing particles)
function model!(args...; particles, kernels=nothing, proposals=nothing, 
                ess_perc_min=0.5, compute_evidence=true, show_progress=true)

# Sampling (creates new particles)
function model(args...; n_particles=1000, kernels=nothing, proposals=nothing,
               ess_perc_min=0.5, compute_evidence=true, show_progress=true)</code></pre><p>Pass external data as function arguments. Both functions return the evidence (log-probability of observations) by default.</p><p>Within <code>@smc</code>, the following operators are available:</p><ul><li><strong>Particle assignment:</strong> <code>x .= expr</code> broadcasts <code>expr</code> to <code>particles.x</code>.</li><li><strong>Sampling:</strong> <code>x ~ SMCKernel(args)</code> samples to <code>particles.x</code> and updates weights.</li><li><strong>Observation:</strong> <code>expr =&gt; SMCKernel(args)</code> updates weights based on observing <code>expr</code>.</li><li><strong>MH Move:</strong> <code>x &lt;&lt; Proposal(args)</code> performs Metropolis-Hastings moves on <code>particles.x</code>.</li></ul><p>Both <code>expr</code> and <code>args</code> can reference <code>particles.x</code> as <code>x</code>.</p><p>Regular Julia constructs are supported:</p><ul><li><strong>Assignment (<code>=</code>):</strong> Creates local variables (not stored in <code>particles</code>).</li><li><strong>For loops:</strong> Supports <code>for i in collection</code> and tuple destructuring, where <code>collection</code> does not involve particle variables.</li><li><strong>Conditionals:</strong> <code>if condition</code> where <code>condition</code> does not involve particle variables.</li></ul><p>Additional features:</p><ul><li><strong>Array indexing:</strong> <code>x[i]</code> maps over <code>particles.x</code>.</li><li><strong>Index interpolation:</strong> <code>x{i}</code> creates dynamic variable names (e.g., <code>x1</code>, <code>x2</code>, ...).</li></ul><h2 id="SMCKernel-type"><a class="docs-heading-anchor" href="#SMCKernel-type">SMCKernel type</a><a id="SMCKernel-type-1"></a><a class="docs-heading-anchor-permalink" href="#SMCKernel-type" title="Permalink"></a></h2><p><code>SMCKernel</code> represents a (random weight) importance sampler:</p><ul><li><code>sampler</code>: <code>(args...) -&gt; sample</code> — generates samples</li><li><code>weighter</code>: <code>(args..., sample) -&gt; log_weight</code> — computes log weights (can be <code>nothing</code> for uniform)</li><li><code>logpdf</code>: <code>(args..., sample) -&gt; log_pdf</code> — evaluates log-density</li></ul><p>Every <code>SMCKernel</code> represents a stochastic kernel given by averaging samples over weights:</p><p class="math-container">\[\int_{w} \text{weighter}(w \mid \text{args}, x) \text{sampler}(x \mid \text{args}) dw\]</p><p>The <code>logpdf</code> is the log-density of this kernel.</p><p>Default kernels are provided for major distributions from Distributions.jl (see <code>smc_kernels.jl</code>), accessible by name in <code>@smc</code>. Custom kernels can be defined using <code>SMCKernel</code> and passed as named tuples to SMC functions.</p><h2 id="MH-moves"><a class="docs-heading-anchor" href="#MH-moves">MH moves</a><a id="MH-moves-1"></a><a class="docs-heading-anchor-permalink" href="#MH-moves" title="Permalink"></a></h2><p>Resampling reduces particle diversity for early-sampled variables. MH moves can restore diversity. Example:</p><pre><code class="language-julia hljs">@smc function linear_regression(xs, ys)
    α ~ Normal(0, 10)
    β ~ Normal(0, 10)
    for (x, y) in zip(xs, ys)
        y =&gt; Normal(α + β * x, 1.0)
        if resampled
            α &lt;&lt; autoRW()
            β &lt;&lt; autoRW()
        end
    end
end</code></pre><p><strong>Note:</strong> Moves require that particle variables are not overwritten before the move, as the MH acceptance ratio depends on previous values.</p><p>Moves are computationally expensive. Use them conditionally, based on the state of the particle approximation. The following variables are available within <code>@smc</code>:</p><ul><li><code>particles</code>: The <code>particles</code> DataFrame</li><li><code>resampled</code>: Boolean, true if resampling occurred in the previous step</li><li><code>ess_perc</code>: Current effective sample size (percent)</li><li><code>evidence</code>: Current accumulated log-probability</li></ul><p>MH kernels are functions <code>Proposal(particles, targets, args...)</code> returning a DataFrame of proposals and a vector of log proposal ratios.</p><p>Available proposals:</p><ul><li><code>RW(step_size)</code>: Symmetric random walk</li><li><code>autoRW(min_step)</code>: Random walk with empirically calibrated covariance</li></ul><p>Joint updates are supported:</p><pre><code class="language-julia hljs">(α, β) &lt;&lt; autoRW()</code></pre><h2 id="Utility-functions"><a class="docs-heading-anchor" href="#Utility-functions">Utility functions</a><a id="Utility-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Utility-functions" title="Permalink"></a></h2><ul><li><code>sample_particles(particles, n; replace=false)</code>: Draw <code>n</code> samples by weight</li><li><code>describe_particles(particles)</code>: Summarize all variables</li><li><code>exp_norm(weights)</code>: Normalize log-weights to probabilities</li><li><code>@E(f, particles)</code>: Compute weighted expectation of function <code>f</code> over particle variables</li></ul><p>Examples:</p><pre><code class="language-julia hljs">@E(x -&gt; x, particles)         # E[x]
@E(x -&gt; x == 1, particles)    # P[x == 1]
@E((x, y) -&gt; x + y, particles) # E[x + y]</code></pre><h2 id="Performance-tips"><a class="docs-heading-anchor" href="#Performance-tips">Performance tips</a><a id="Performance-tips-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-tips" title="Permalink"></a></h2><ul><li>Main bottleneck is resampling; many distinct variables (&gt;10k) slow performance.</li><li>Overwriting particle variables marginalizes them.</li><li>Use static, concrete types (e.g., <code>StaticArrays.SVector</code>) for efficiency.</li><li>Moves are expensive; use only when necessary.</li></ul><h2 id="Saving-particle-history"><a class="docs-heading-anchor" href="#Saving-particle-history">Saving particle history</a><a id="Saving-particle-history-1"></a><a class="docs-heading-anchor-permalink" href="#Saving-particle-history" title="Permalink"></a></h2><p>Monitor SMC progress by saving snapshots:</p><pre><code class="language-julia hljs">ess_list = []
history = []

@smc function ssm(observations, ess_list, history)
    I = [1 0; 0 1]
    x .= [0.0, 0.0]
    v .= [1.0, 0.0]

    for obs in observations
        # Save snapshot
        push!(ess_list, ess_perc)
        push!(history, particles.x)

        x .= x + v
        dv ~ MvNormal([0,0], 0.1*I)
        v .= v + dv
        obs =&gt; MvNormal(x, 0.5*I)
    end
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../api/">API Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Friday 3 October 2025 07:18">Friday 3 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
